{% extends 'base.html' %}

{% block title %}Jawabin - Sistem Tanya Jawab Ekstraktif{% endblock %}

{% block content %}

<div class="container pt-5">
    <!-- Hero Section -->
    <div class="hero-card mt-6" data-aos="fade-up">
        <div class="row">
            <!-- Left Content -->
            <div class="col-lg-5 mb-5 mb-lg-0" data-aos="fade-right" data-aos-delay="200">
                <div class="brand-badge">
                    <img src="{{ url_for('static', filename='assets/img/jawabin-logo.png') }}" alt="logo-jawabin"
                        class="img-fluid" width="20">
                    <span>&nbsp;Jawabin</span>
                </div>

                <h1 class="display-4 fw-bold text-gradient">Cari Jawaban Cepat Tanpa Ribet!</h1>
                <div class="title-line"></div>
                <img id="illustrationImage" class="img-fluid mb-2"
                    src="{{ url_for('static', filename='assets/img/illustrations/confuse-prediction.png') }}"
                    alt="Jawabin Illustration">
                <p class="lead">Biarkan AI kami bantu kamu temukan jawaban paling relevan langsung dari
                    teks. Gak perlu
                    cari manual — cukup masukkan
                    konteks dan pertanyaanmu!</p>

            </div>

            <!-- Right Form -->
            <div class="col-lg-7" data-aos="fade-left" data-aos-delay="200">
                <div class="input-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h4 class="mb-0">Cari Jawabanmu Sekarang</h4>
                    </div>

                    <form id="predictForm">
                        <div class="mb-4">
                            <label for="model" class="form-label">Pilih Model</label>
                            <select class="form-select" id="model" name="model" aria-label="Model selection">
                                <option value="" selected>Pilih model konfigurasi</option>
                                <!-- This will be populated dynamically -->
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="context" class="form-label">Konteks</label>
                            <textarea class="form-control" id="context" name="context" rows="6"
                                placeholder="Masukkan teks konteks yang akan dianalisis..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label for="question" class="form-label">Pertanyaan</label>
                            <textarea class="form-control" id="question" name="question" rows="2"
                                placeholder="Masukkan pertanyaan yang ingin dijawab..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-predict w-100">
                            <i class="fas fa-search"></i>&nbsp;Prediksi
                        </button>
                    </form>

                    <!-- Loading spinner -->
                    <div class="spinner-container" id="loadingSpinner">
                        <div class="spinner"></div>
                        <p class="mt-3">Sedang menganalisis...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-section mb-6" id="resultsSection" style="display: none;">
        <div class="results-header">
            <h2>Hasil Prediksi</h2>
            <span class="results-badge" id="confidenceBadge"></span>
        </div>

        <div class="row g-4">
            <!-- Context Card -->
            <div class="col-lg-5">
                <div class="context-card">
                    <div class="context-title">
                        <i class="fas fa-quote-left"></i>
                        <h5 class="mb-0">Konteks dengan Highlight</h5>
                    </div>

                    <div class="context-content">
                        <p class="mb-0" id="highlightedContext">
                        </p>
                    </div>

                    <div class="context-stats">
                        <div class="context-stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-text-height"></i>
                            </div>
                            <div class="stat-text">
                                <strong id="answerLengthText">16 Karakter</strong>
                                Panjang Jawaban
                            </div>
                        </div>

                        <div class="context-stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-paragraph"></i>
                            </div>
                            <div class="stat-text">
                                <strong id="answerPositionText">Tengah Paragraf</strong>
                                Posisi Jawaban
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Answer and Metrics -->
            <div class="col-lg-7">
                <!-- Answer Card -->
                <div class="answer-card">
                    <div class="answer-heading">
                        <i class="fas fa-check-circle me-2"></i> Jawaban Terdeteksi
                    </div>
                    <div class="answer-text">
                        <p class="answer-text-quote" id="answerText"></p>
                    </div>
                </div>

                <!-- Metrics Cards -->
                <div class="metrics-container">
                    <!-- Start Position -->
                    <div class="metric-card">
                        <h6 class="metric-title">Posisi<br>Awal</h6>
                        <div class="progress-circle">
                            <svg viewBox="0 0 140 140">
                                <circle class="progress-bg" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-arc progress-start" cx="70" cy="70" r="65"
                                    stroke-dasharray="408.4" stroke-dashoffset="102.1"></circle>
                            </svg>
                            <div class="progress-text">
                                <p class="progress-value" id="startPositionValue"></p>
                                <p class="progress-label">Karakter</p>
                            </div>
                        </div>
                        <div class="metric-info">
                            <strong id="startPositionPercentage"></strong> dari total teks
                        </div>
                    </div>

                    <!-- End Position -->
                    <div class="metric-card">
                        <h6 class="metric-title">Posisi<br>Akhir</h6>
                        <div class="progress-circle">
                            <svg viewBox="0 0 140 140">
                                <circle class="progress-bg" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-arc progress-end" cx="70" cy="70" r="65"
                                    stroke-dasharray="408.4" stroke-dashoffset="81.68"></circle>
                            </svg>
                            <div class="progress-text">
                                <p class="progress-value" id="endPositionValue">72</p>
                                <p class="progress-label">Karakter</p>
                            </div>
                        </div>
                        <div class="metric-info">
                            <strong id="endPositionPercentage">32%</strong> dari total teks
                        </div>
                    </div>

                    <!-- Confidence Score -->
                    <div class="metric-card">
                        <h6 class="metric-title">Confidence<br>Score</h6>
                        <div class="progress-circle">
                            <svg viewBox="0 0 140 140">
                                <circle class="progress-bg" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-arc progress-confidence" cx="70" cy="70" r="65"
                                    stroke-dasharray="408.4" stroke-dashoffset="40.84"></circle>
                            </svg>
                            <div class="progress-text">
                                <p class="progress-value" id="confidenceValue">90%</p>
                                <p class="progress-label">Kepercayaan</p>
                            </div>
                        </div>
                        <div class="metric-info">
                            <strong id="confidenceText">Tinggi</strong> - Jawaban sangat akurat
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Integration with Flask API -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get form elements
        const form = document.getElementById('predictForm');
        const contextInput = document.getElementById('context');
        const questionInput = document.getElementById('question');
        const modelSelect = document.getElementById('model');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Get results section elements
        const resultsSection = document.getElementById('resultsSection');
        const confidenceBadge = document.getElementById('confidenceBadge');
        const highlightedContext = document.getElementById('highlightedContext');
        const answerText = document.getElementById('answerText');
        const answerLengthText = document.getElementById('answerLengthText');
        const answerPositionText = document.getElementById('answerPositionText');

        // Get progress circles elements
        const startPositionValue = document.getElementById('startPositionValue');
        const endPositionValue = document.getElementById('endPositionValue');
        const confidenceValue = document.getElementById('confidenceValue');

        // Get progress circles SVG elements
        const startPositionCircle = document.querySelector('.progress-start');
        const endPositionCircle = document.querySelector('.progress-end');
        const confidenceCircle = document.querySelector('.progress-confidence');

        // Get metric info elements
        const startPositionPercentage = document.getElementById('startPositionPercentage');
        const endPositionPercentage = document.getElementById('endPositionPercentage');
        const confidenceText = document.getElementById('confidenceText');

        // Hide loading spinner initially
        loadingSpinner.style.display = 'none';

        // Fetch available models from the server
        fetchAvailableModels();

        // Handle form submission
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            // Get input values
            const context = contextInput.value.trim();
            const question = questionInput.value.trim();
            const model = modelSelect.value;

            // Validate inputs
            if (!model) {
                alert('Harap pilih model konfigurasi.');
                modelSelect.focus();
                return;
            }

            if (!context) {
                alert('Harap isi bagian konteks.');
                contextInput.focus();
                return;
            }

            if (!question) {
                alert('Harap isi bagian pertanyaan.');
                questionInput.focus();
                return;
            }

            // Show loading spinner
            form.style.display = 'none';
            loadingSpinner.style.display = 'block';

            // Hide results section while loading
            resultsSection.style.display = 'none';

            // Send API request
            fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    context: context,
                    question: question,
                    model_path: model  // Send the full model path
                }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading spinner and show form again
                    loadingSpinner.style.display = 'none';
                    form.style.display = 'block';

                    // Update UI with results
                    updateResults(data, context);

                    // Show results section
                    resultsSection.style.display = 'block';

                    // Scroll to results
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Terjadi kesalahan saat memproses permintaan Anda. Silakan coba lagi.');
                    loadingSpinner.style.display = 'none';
                    form.style.display = 'block';
                });
        });

        function fetchAvailableModels() {
            fetch('/get_available_models')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch available models');
                    }
                    return response.json();
                })
                .then(data => {
                    // Clear current options
                    modelSelect.innerHTML = '<option value="" selected>Pilih model konfigurasi</option>';

                    // Add options for each available model
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.path;
                        option.textContent = model.name;
                        modelSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching models:', error);
                    alert('Gagal memuat daftar model. Silakan refresh halaman.');
                });
        }

        function updateResults(data, context) {
            // Ganti ilustrasi saat jawaban ditemukan
            const illustrationImage = document.getElementById('illustrationImage');
            illustrationImage.src = "{{ url_for('static', filename='assets/img/illustrations/answer-prediction.png') }}";

            // Extract data
            const answer = data.answer;
            const start = data.start;
            const end = data.end;
            const score = data.score;

            // Format confidence score as percentage
            const confidencePercentage = Math.round(score * 100);

            // Update confidence badge
            confidenceBadge.textContent = `${confidencePercentage}% Confidence`;

            // Update answer
            answerText.textContent = answer;

            // Create highlighted context
            const beforeAnswer = context.substring(0, start);
            const actualAnswer = context.substring(start, end);
            const afterAnswer = context.substring(end);

            highlightedContext.innerHTML = escapeHTML(beforeAnswer) +
                `<span class="highlight-answer">${escapeHTML(actualAnswer)}</span>` +
                escapeHTML(afterAnswer);

            // Update answer stats
            answerLengthText.textContent = `${answer.length} Karakter`;

            // Determine answer position description
            let positionDescription = 'Tengah Paragraf';
            const contextThird = context.length / 3;

            if (start < contextThird) {
                positionDescription = 'Awal Paragraf';
            } else if (start > contextThird * 2) {
                positionDescription = 'Akhir Paragraf';
            }

            answerPositionText.textContent = positionDescription;

            // Update progress circles
            startPositionValue.textContent = start;
            endPositionValue.textContent = end;
            confidenceValue.textContent = `${confidencePercentage}%`;

            // Calculate percentage for start and end positions
            const startPercentage = Math.round((start / context.length) * 100);
            const endPercentage = Math.round((end / context.length) * 100);

            // Update start position info
            startPositionPercentage.textContent = `${startPercentage}%`;

            // Update end position info
            endPositionPercentage.textContent = `${endPercentage}%`;

            // Update confidence info
            let confidenceDescription = 'Rendah';
            if (score > 0.7) {
                confidenceDescription = 'Tinggi';
            } else if (score > 0.4) {
                confidenceDescription = 'Sedang';
            }

            confidenceText.textContent = confidenceDescription;

            // Update SVG circle strokes
            // The circumference of the circle is 2πr = 2 * 3.14159 * 65 ≈ 408.4
            const circumference = 408.4;

            // Calculate stroke-dashoffset for each circle
            // Formula: circumference * (1 - percentage/100)
            const startOffset = circumference * (1 - startPercentage / 100);
            const endOffset = circumference * (1 - endPercentage / 100);
            const confidenceOffset = circumference * (1 - confidencePercentage / 100);

            // Update stroke-dashoffset values
            startPositionCircle.setAttribute('stroke-dashoffset', startOffset);
            endPositionCircle.setAttribute('stroke-dashoffset', endOffset);
            confidenceCircle.setAttribute('stroke-dashoffset', confidenceOffset);
        }

        // Helper function to escape HTML special characters
        function escapeHTML(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    });
</script>
{% endblock %}